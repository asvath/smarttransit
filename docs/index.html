<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TTC Delay Insights ‚Äî Toronto Subway: Delay Stats</title>
  <style>
    :root{
      --red:#dc2626; --border:#313131; --muted:#9ca3af; --bg:#0b0b0c; --green:#a3e635;
      --btn:#16171a; --btn-border:#2a2a2f; --btn-hover:#1e2024; --btn-active:#262a30; --focus:#a7b0ff;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: Inter, system-ui, Segoe UI, Arial; background:var(--bg); color:#f5f5f6; font-size:18px; line-height:1.55; }

    header{ position:sticky; top:0; z-index:10; background:#0f0f11; border-bottom:1px solid var(--border); }
    .container{ max-width:1360px; margin:0 auto; padding:18px 22px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .badge{ width:44px; height:44px; border-radius:12px; background:var(--red); color:#fff; display:grid; place-items:center; font-weight:700; font-size:18px; }
    .muted{ color:var(--muted); }

    .nav{ display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .btn{ border:1px solid var(--border); background:#121214; color:#f5f5f6; padding:16px 22px; border-radius:12px; cursor:pointer; font-weight:700; font-size:18px; text-decoration:none; display:inline-block; }
    .btn.primary{ background:var(--red); color:#fff; border-color:var(--red); }

    main{ max-width:1360px; margin:20px auto; padding:0 22px; }
    .card{ background:#121214; border:1px solid var(--border); border-radius:16px; box-shadow:0 1px 3px rgba(0,0,0,.35); width:100%; }
    .content{ padding:28px; }

    .welcome{ display:flex; gap:16px; align-items:flex-start; margin-bottom:16px; border:1px solid var(--border); border-radius:16px; background:#101012; }
    .welcome .content{ padding:28px; }
    .welcome h2{ margin:0 0 8px; font-size:30px; }
    .welcome p{ margin:6px 0; color:#d1d5db; font-size:18px; line-height:1.7; }
    .welcome p.lead{ font-size:20px; line-height:1.7; color:#e8eaee; }

    .tip{ margin:12px 0; border:1px dashed #2a2a2a; border-radius:12px; background:#0f1012; padding:12px 14px; font-size:16.5px; color:#d8dbe2; }

    .buffer-card{ background:#121214; border:1px solid var(--border); border-radius:16px; margin:16px 0 20px; }
    .buffer-content{ padding:28px; }
    .buffer-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .buffer-title{ font-weight:700; font-size:24px; }
    .buffer-controls{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    select, .pill{ background:#141417; border:1px solid #2a2a2a; color:#e5e7eb; border-radius:12px; padding:14px 16px; font-size:18px; min-width:200px; }
    .badge-dot{ width:16px; height:16px; border-radius:999px; display:inline-block; vertical-align:middle; }
    .buffer-rows{ margin-top:12px; border:1px solid var(--border); border-radius:12px; }
    .buffer-row{ display:flex; justify-content:space-between; padding:15px 18px; font-size:18px; }
    .buffer-row + .buffer-row{ border-top:1px dashed #2a2a2a; }
    .buffer-note{ color:#cfd3da; font-size:14.5px; margin-top:10px; }

    .hero{ display:grid; grid-template-columns: 8fr 4fr; gap:22px; }
    @media (max-width:1200px){ .hero{ grid-template-columns:1fr; } }

    .mapbox{ height:72vh; min-height:540px; position:relative; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:#0b0b0c; }
    #leaflet-map{ position:absolute; inset:0; }
    .legend{ display:flex; gap:14px; align-items:center; font-size:14.5px; color:#d1d5db; flex-wrap:wrap; }
    .dot{ width:12px; height:12px; border-radius:999px; display:inline-block; }

    .kpi{ display:flex; justify-content:space-between; gap:10px; margin:10px 0; padding:14px; border:1px solid var(--border); border-radius:12px; font-size:18px; }
    .kpi > span{ flex:1; }
    .kpi > strong{ flex:1; text-align:right; display:block; font-size:20px; }

    a{ color:var(--green); text-decoration:none; font-weight:600; }
    footer{ padding:28px 22px; text-align:center; color:#9ca3af; }
    footer a{ font-weight:inherit !important; color:inherit !important; text-decoration:none !important; }

    .leaflet-control-attribution{ background: rgba(18,18,20,.85) !important; color: #c7c9ce !important; border-radius: 8px !important; padding: 2px 6px !important; font-size: 12px !important; }
    .leaflet-control-container .leaflet-control a { color: #a7b0ff !important; }

    .hotspot-toggle { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 8px; }
    .hot-btn{
      appearance:none; border:1px solid var(--btn-border); background:var(--btn);
      color:#e8eaee; padding:10px 14px; border-radius:10px; font-size:15px; font-weight:700;
      cursor:pointer; transition:background .15s ease, border-color .15s ease, transform .02s ease;
    }
    .hot-btn:hover{ background:var(--btn-hover); }
    .hot-btn:active{ transform:translateY(1px); }
    .hot-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }
    .hot-btn.is-active{ background:var(--btn-active); border-color:#3a3f47; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }

    .hot-label{ color:#d1d5db; font-size:18px; margin-top:6px; }
    .hot-caption{ color:#cfd3da; font-size:17px; margin-top:2px; }

    .hotspot-icon { width:44px; height:44px; border-radius:999px; display:grid; place-items:center; background:#1a1b1e; border:1px solid #2a2a2a; font-size:24px; }
    .hotspot-emoji { display:inline-block; transform: translateY(2px); }

    .leaflet-popup-close-button{
      color:#000 !important;
      font-weight:900 !important;
      font-size:22px !important;
      line-height:22px !important;
      width:28px; height:28px;
      top:6px; right:6px;
      opacity:1 !important;
      text-shadow:none !important;
    }
    .leaflet-popup-close-button:hover{ opacity:1; }

    .hero.container { margin-top:16px; }
    .hero .card:first-child .content > div[style*="font-weight:700; font-size:22px;"] {
      font-size: 24px !important;
      font-weight: 700 !important;
      margin-bottom: 10px !important;
    }

    /*  welcome / raccoon section */
    .welcome-flex { display: flex; align-items: flex-start; gap: 14px; }
    .icon-pair { position: relative; display: inline-block; width: 220px; height: auto; flex-shrink: 0; margin-top: 4px; }
    .maple-left { position: absolute; top: 0; left: 0; width: 150px; height: auto; opacity: 0.95; z-index: 1; }
    .raccoon-left { position: absolute; top: 0; left: 90px; width: 150px; height: auto; opacity: 0.95; z-index: 2; }
    .welcome-text { flex: 1; text-align: center; max-width: 850px; margin: 0 auto; }
    .welcome-text h2 { margin: 0 0 8px; font-size: 30px; line-height: 1.25; font-weight: 700; color: #fff; }
    .welcome strong { font-weight: 550; color: #f0f1f3; }
    .welcome a { color: inherit; text-decoration: underline; text-underline-offset: 2px; }
    .welcome a:hover { color: #f87171; }

    /* ===== Mobile parts ===== */
    .hamburger{
      display:none; width:42px; height:42px; border:1px solid var(--border);
      background:#121214; border-radius:10px; align-items:center; justify-content:center;
      gap:5px; flex-direction:column; cursor:pointer;
    }
    .hamburger span{ width:22px; height:2px; background:#e8eaee; display:block; transition:transform .2s ease, opacity .2s ease; }
    .hamburger.is-open span:nth-child(1){ transform:translateY(7px) rotate(45deg); }
    .hamburger.is-open span:nth-child(2){ opacity:0; }
    .hamburger.is-open span:nth-child(3){ transform:translateY(-7px) rotate(-45deg); }

    /* Mobile polish ‚â§860px */
    @media (max-width: 860px){
      html, body { overflow-x: hidden; }
      header .container{ gap:10px; }
      .hamburger{ display:flex; }
      .nav{
        position:absolute; top:100%; right:22px; left:22px; background:#101012; border:1px solid var(--border);
        border-radius:12px; padding:10px; display:none; flex-direction:column; gap:8px; z-index:20; box-shadow:0 8px 24px rgba(0,0,0,.35);
      }
      .nav.is-open{ display:flex; }
      .btn{ width:100%; text-align:center; padding:12px 14px; font-size:16px; }

      .welcome-flex{ flex-direction:column; align-items:center; text-align:center; }
      .icon-pair{ position:relative; display:block; width:220px; height:130px; margin:6px auto 12px; overflow:visible; }
      .maple-left, .raccoon-left{ position:absolute !important; height:auto; opacity:.95; max-width:none; }
      .maple-left{ top:0; left:0; width:130px; z-index:1; }
      .raccoon-left{ top:0; left:70px; width:145px; z-index:2; }

      .hero { display:block; gap:0; }
      .hero.container { overflow:visible; padding-left:0; padding-right:0; }
      .hero .card { width:100% !important; max-width:100% !important; margin:0 0 14px; }
      .hero .card .content { max-width:100%; box-sizing:border-box; padding-left:6px; padding-right:6px; overflow-x:hidden; }

      .mapbox, #leaflet-map, .leaflet-container {
        width:100% !important; max-width:100% !important; height:50vh; min-height:360px; box-sizing:border-box;
      }

      .buffer-header{ flex-direction:column; align-items:flex-start; gap:10px; }
      .buffer-controls{ width:100%; }

      /* Hide in-map legend UI on mobile only */
      #legend-toggle, #legend-panel{ display:none !important; }

      /* Station search stacking safety */
      .buffer-controls, .buffer-controls * { min-width:0; }
      #station-search { display:block; width:100%; box-sizing:border-box; }
      #station-go { display:block; width:100%; box-sizing:border-box; margin-top:8px; }

      .leaflet-popup-content-wrapper{ max-width:340px !important; border-radius:12px !important; }
      .leaflet-popup-content{ max-height:none !important; overflow:visible !important; margin:10px 14px !important; }

      .content, .buffer-rows, .legend { max-width:100%; overflow-x:hidden; box-sizing:border-box; }

      .rotate-hint {
        display: block;
        text-align: center;
        font-size: 15px;
        color: #e5e7eb;
        margin: 10px auto;
        padding: 8px 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        width: fit-content;
        font-style: italic;
        letter-spacing: 0.2px;
        backdrop-filter: blur(4px);
      }

    /* Hide rotation hint on desktop or landscape */
    .rotate-hint {
      display: none;
    }

    /* Show ONLY on small portrait touch screens */
    @media (max-width: 860px) and (orientation: portrait) and (hover: none) and (pointer: coarse) {
      .rotate-hint {
        display: block;
      }
    }

    @media (max-width: 720px) {
      body{ font-size:16px; }
      .container{ padding:14px 14px; }
      .welcome .content{ padding:16px; }
      .welcome-text h2{ font-size:22px; line-height:1.35; }
      .welcome p.lead{ font-size:16px; line-height:1.6; }
      select, .pill{ min-width:140px; padding:10px 12px; font-size:15px; }
      .buffer-row{ font-size:16px; padding:12px 14px; }
      .legend{ gap:10px; font-size:13px; }
      .kpi{ padding:12px; font-size:16px; }
      .kpi > strong{ font-size:18px; }
      .leaflet-popup-content-wrapper{ max-width:260px !important; border-radius:12px !important; }
      .leaflet-popup-content{ max-height:44vh; overflow:auto; margin:8px 12px !important; }
      .leaflet-popup .kpi{ padding:8px; font-size:14px; }
      .leaflet-popup .kpi > strong{ font-size:15px; }
    }

    [id]{ scroll-margin-top: 80px; }
    main { margin-bottom: 0 !important; }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;position:relative;">
      <div class="brand">
        <div class="badge">TTC</div>
        <div>
          <div style="font-weight:700;font-size:20px;">TTC Delay Insights</div>
          <div class="muted" style="font-size:16px;">Data today, better commutes tomorrow.</div>
        </div>
      </div>

      <!-- Mobile hamburger (hidden on desktop via CSS) -->
      <button class="hamburger" id="menu-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="site-nav">
        <span></span><span></span><span></span>
      </button>

      <div class="nav" id="site-nav">
        <a class="btn primary" href="index.html" aria-current="page">Home</a>
        <a class="btn" href="overview.html">Overview</a>
        <a class="btn" href="delayleaderboard.html">Delay Leaderboard</a>
        <a class="btn" href="ttcdelaydodge.html">Play TTC Delay Dodge</a>
        <a class="btn" href="about.html">About</a>
        <a class="btn" href="donate.html">Donate</a>
      </div>
    </div>
  </header>

  <main>

    <div class="welcome container card" role="region" aria-label="Welcome">
      <div class="content">
        <div class="welcome-flex">
          <div class="icon-pair">
            <img src="assets/maple.png" alt="Red maple leaf icon representing Canada" class="maple-left">
            <img src="assets/trackintruder.png" alt="Track-intruding raccoon ‚Äî Toronto‚Äôs unofficial mascot" class="raccoon-left">
          </div>

          <div class="welcome-text">
            <h2>Welcome to TTC Delay Insights: <br> Data today, better commutes tomorrow.</h2>

            <p class="rotate-hint"><em>For the best experience, rotate your phone horizontally.</em></p>


            <p class="lead">
              Use the <strong>Plan your buffer time</strong> tool below to plan your trip and stay ahead of TTC delays. <br>
              Explore the <strong>Toronto Subway: Delay Stats</strong> interactive map to see delay stats for each station. <br>
              Want more? Explore the <a href="overview.html"><strong>Overview</strong></a> for in-depth insights and recommendations, <br>
              check the <a href="delayleaderboard.html"><strong>Delay Leaderboard</strong></a> to see which stations have the most time lost this year, <br>
              or play the <a href="ttcdelaydodge.html"><strong>TTC Delay Dodge Game</strong></a>:
              dodge delays caused by track-intruding raccoons, grab Jamaican patties for bonus points, and see if you can beat the high score before your next train!
            </p>
          </div>
        </div>
      </div>
    </div>

    <section class="buffer-card container" aria-label="Plan your buffer time">
      <div class="buffer-content">
        <div class="buffer-header">
          <div class="buffer-title">Plan Your Buffer Time</div>
          <div class="buffer-controls">
            <span class="pill" style="display:flex;align-items:center;gap:10px">
              <span class="badge-dot" id="line-dot"></span>
              <select id="line-select" aria-label="Select Line"></select>
            </span>
            <select id="dir-select" aria-label="Select Direction"></select>
          </div>
        </div>
        <div id="buffer-rows" class="buffer-rows" role="table" aria-label="Average extra minutes by time of day"></div>
        <div class="buffer-note">Based on average delays over the last 3 years. Add these minutes to your trip as a buffer.</div>
      </div>
    </section>


    <div class="hero container">
      <div class="card">
        <div class="content">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div style="font-weight:700; font-size:22px;">Toronto Subway: Delay Stats</div>
            <div class="legend">
              <span><span class="dot" style="background:#FFD300"></span> Line 1</span>
              <span><span class="dot" style="background:#00A94F"></span> Line 2</span>
              <span><span class="dot" style="background:#9C27B0"></span> Line 4</span>
            </div>
          </div>

          <div id="tip-banner" class="tip" role="note" aria-label="Map tip">
            <strong>Tip:</strong> Select a station to view its general delay stats in the side panel. Use Hotspots to highlight station hotspots for Track Intrusions, Disorderly Patrons, or Fires.
          </div>

          <div class="mapbox">
            <div id="leaflet-map"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="content">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px">
            <input id="station-search" type="search" placeholder="Search station‚Ä¶" aria-label="Search station"
                   style="flex:1; padding:12px 14px; border-radius:10px; border:1px solid #2a2a2a; background:#141417; color:#e5e7eb; font-size:16px"
                   list="stations-list"/>
            <datalist id="stations-list"></datalist>
            <button id="station-go" class="btn" type="button" aria-label="Search station">Search</button>
          </div>

          <h3 id="st-name" style="margin:0 0 8px 0; font-size:20px;">Select a station</h3>

          <div class="hot-label">Hotspots</div>
          <div class="hot-caption">(click buttons to toggle hotspots on the map).</div>
          <div class="hotspot-toggle" id="hotspot-toggles" aria-label="Delay Hotspot Filters">
            <button type="button" class="hot-btn is-active" data-hot="ALL" aria-pressed="true">All off</button>
            <button type="button" class="hot-btn" data-hot="Track Intrusion" aria-pressed="false">Track Intrusion</button>
            <button type="button" class="hot-btn" data-hot="Disorderly Patron" aria-pressed="false">Disorderly Patron</button>
            <button type="button" class="hot-btn" data-hot="Fire: Track Level" aria-pressed="false">Fire</button>
          </div>

          <div id="station-kpis" aria-live="polite">
            <div class="kpi"><span>Total delays</span><strong id="st-delays">‚Äî</strong></div>
            <div class="kpi"><span>Time lost to delays</span><strong id="st-time-total">‚Äî</strong></div>
            <div class="kpi"><span>Major delays (&gt; 20m)</span><strong id="st-major">‚Äî</strong></div>
            <div class="kpi"><span>Top delay cause</span><strong id="st-top-reason">‚Äî</strong></div>
            <div class="kpi"><span>Time lost due to top delay</span><strong id="st-time-top">‚Äî</strong></div>
          </div>

          <div class="muted" style="font-size:15px;margin-top:10px">
            <div>Stats based on 2024 data</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    Toronto Open Data ‚Ä¢
    <a href="https://ashaasvathaman.com" style="color:inherit; text-decoration:none;">
      Asha Asvathaman
    </a>
  </footer>

  <script>
    const LINES_URL      = "./data/ttc_lines.geojson";
    const STATIONS_URL   = "./data/ttc_subway_geodata.json";
    const STATS_URL      = "./data/stations_stats.json";
    const CODE_STATS_URL = "./data/code_specific_stats.json";
    const LINE_STATS_URL = "./data/line_stats.json";

    const COLOR = {
      "Line 1 ‚Äì Yonge‚ÄìUniversity": "#FFD300",
      "Line 2 ‚Äì Bloor‚ÄìDanforth":   "#00A94F",
      "Line 3 ‚Äì Scarborough (legacy)": "#00B5E2",
      "Line 4 ‚Äì Sheppard":         "#9C27B0",
    };
    const DEFAULT_COLOR = "#6aa3ff";
    const COLOR_MAP = {
      "Line 1 ‚Äì Yonge‚ÄìUniversity": "#FFD300",
      "Line 2 ‚Äì Bloor‚ÄìDanforth":   "#00A94F",
      "Line 4 ‚Äì Sheppard":         "#9C27B0",
    };

    function get_route_name(props){
      if(!props) return null;
      if("ROUTE_NAME" in props) return props.ROUTE_NAME;
      if("ROUTE_LONG_NAME" in props) return props.ROUTE_LONG_NAME;
      if("route" in props) return props.route;
      if("name" in props) return props.name;
      return null;
    }
    function canonical_line(name){
      if(typeof name !== "string") return "Unknown";
      const n = name.toUpperCase();
      if(n.includes("LINE 1") || n.includes("YONGE") || n.includes("UNIVERSITY")) return "Line 1 ‚Äì Yonge‚ÄìUniversity";
      if(n.includes("LINE 2") || n.includes("BLOOR") || n.includes("DANFORTH"))   return "Line 2 ‚Äì Bloor‚ÄìDanforth";
      if(n.includes("LINE 3") || n.includes("SCARBOROUGH"))                        return "Line 3 ‚Äì Scarborough (legacy)";
      if(n.includes("LINE 4") || n.includes("SHEPPARD"))                           return "Line 4 ‚Äì Sheppard";
      return name;
    }
    function hoursToHM(h){
      if (typeof h !== "number" || !isFinite(h)) return "‚Äî";
      const totalMinutes = Math.round(h * 60);
      const hrs = Math.floor(totalMinutes / 60);
      const mins = totalMinutes % 60;
      return hrs > 0 ? `${hrs} hr ${mins} min` : `${mins} min`;
    }
    function hoursToHMVerbose(h){
      if (typeof h !== "number" || !isFinite(h)) return "‚Äî";
      const totalMinutes = Math.max(0, Math.round(h * 60));
      const hrs = Math.floor(totalMinutes / 60);
      const mins = totalMinutes % 60;
      return `${hrs} h ${mins} min`;
    }
    function formatReason(s){
      if (!s || s === "‚Äî") return "‚Äî";
      const idx = s.indexOf(":");
      if (idx > -1){
        const cat = s.slice(0, idx).trim();
        const det = s.slice(idx+1).trim();
        return `<span class="reason-cat">${cat}:</span><br><span class="reason-detail">${det}</span>`;
      }
      return s;
    }

    const stationStatsMap = {};
    fetch(STATS_URL).then(r => {
      if(!r.ok) throw new Error("Failed to load station stats JSON");
      return r.json();
    }).then(js => {
      const list = js.stations_stats || js.station_stats || [];
      list.forEach(entry => {
        const [rawName, data] = Object.entries(entry)[0] || [];
        if(!rawName || !data) return;
        const key = String(rawName).toUpperCase().trim();

        stationStatsMap[key] = {
          year: data.year,
          total_delays: data.total_delays ?? data["total_delays"],
          time_lost_hours:
            data.time_lost_hours ?? data["time_lost_hours"] ??
            (typeof data.time_lost_minutes === "number" ? (data.time_lost_minutes/60) : undefined),
          major_delays: data.major_delays ?? data["major_delays"],
          top_reason_for_delays_by_time:
            data.top_reason_for_delays_by_time ??
            data["top_reason_for_delays_by_time"] ??
            data["top_reason_for_delays (by time)"],
          time_lost_due_to_top_delay_by_time:
            data.time_lost_due_to_top_delay_by_time ??
            data["time_lost_due_to_top_delay_by_time"],
          fallback_reason:
            data.top_reason_for_delays ??
            data.top_reason_for_delay ??
            data["top_reason_for_delays (by count)"],
          fallback_reason_time:
            data.time_lost_due_to_top_delay_by_count
        };
      });
    }).catch(err => { console.error(err); });

    const map = L.map('leaflet-map', { zoomSnap: 0.1, zoomDelta: 0.1 }).setView([43.71, -79.41], 11.7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    const stationsGroup = L.layerGroup().addTo(map);
    let linesLayer;

    const stationLatLngIndex = new Map();
    const stationMarkersByName = new Map();
    let defaultTarget = null;

    fetch(LINES_URL).then(r => {
      if(!r.ok) throw new Error("Failed to load lines geojson");
      return r.json();
    }).then(geojson => {
      linesLayer = L.geoJSON(geojson, {
        style: f => {
          const rn = get_route_name(f.properties);
          const canon = canonical_line(rn);
          const color = COLOR[canon] || DEFAULT_COLOR;
          return { color, weight: 5, opacity: 0.95 };
        },
        filter: f => canonical_line(get_route_name(f.properties)) !== "Line 3 ‚Äì Scarborough (legacy)",
        onEachFeature: (f, layer) => {
          const rn = get_route_name(f.properties) || "TTC Subway Line";
          layer.bindTooltip(rn);
        }
      }).addTo(map);
      stationsGroup.bringToFront();
    }).catch(err => { console.error(err); });

    function buildStationPopup(name){
      const key = name.toUpperCase().trim();
      const s = stationStatsMap[key] || {};
      const total = (typeof s.total_delays === "number") ? s.total_delays : "‚Äî";
      const timeH = (typeof s.time_lost_hours === "number") ? s.time_lost_hours : "‚Äî";
      const major = (typeof s.major_delays === "number") ? s.major_delays : "‚Äî";
      const reason= s.top_reason_for_delays_by_time || s.fallback_reason || "‚Äî";
      return `
        <div style="min-width:220px">
          <div style="font-weight:700;margin-bottom:6px">${name}</div>
          <div class="kpi" style="margin:6px 0"><span>Total delays</span><strong>${total}</strong></div>
          <div class="kpi" style="margin:6px 0"><span>Time lost</span><strong>${timeH}</strong></div>
          <div class="kpi" style="margin:6px 0"><span>Major delays</span><strong>${major}</strong></div>
          <div class="kpi" style="margin:6px 0"><span>Top cause</span><strong>${reason}</strong></div>
        </div>
      `;
    }

    fetch(STATIONS_URL).then(r => {
      if(!r.ok) throw new Error("Failed to load stations geodata");
      return r.json();
    }).then(rows => {
      const namesForDatalist = [];

      rows.forEach(s => {
        if (typeof s.lat !== "number" || typeof s.lon !== "number") return;
        const stationName = s["station name"] || "Station";
        const stationKey = String(stationName).toUpperCase().trim();
        stationLatLngIndex.set(stationKey, [s.lat, s.lon]);

        const marker = L.circleMarker([s.lat, s.lon], {
          radius: 8,
          color: "black",
          weight: 2,
          fillColor: "white",
          fillOpacity: 1.0
        }).bindTooltip(stationName);

        marker.on("click", () => { selectStation(stationName, s.lat, s.lon); });

        stationsGroup.addLayer(marker);
        stationMarkersByName.set(stationKey, marker);
        namesForDatalist.push(stationName);

        if (!defaultTarget) {
          const u = stationKey;
          if (u.includes("BLOOR") && u.includes("YONGE")) {
            defaultTarget = { name: stationName, lat: s.lat, lon: s.lon };
          }
        }
      });

      const dl = document.getElementById('stations-list');
      namesForDatalist.sort().forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        dl.appendChild(opt);
      });

      focusDefaultStation(defaultTarget);
      loadHotspots();
    }).catch(err => { console.error(err); });

    function selectStation(stationName, lat, lon){
      document.getElementById("st-name").textContent = stationName;

      const key = stationName.toUpperCase().trim();
      const stats = stationStatsMap[key];

      const totalDelays = stats?.total_delays;
      const totalTimeH  = stats?.time_lost_hours;
      const majorDelays = stats?.major_delays;

      const topReasonByTime =
        stats?.top_reason_for_delays_by_time ??
        stats?.fallback_reason ?? "‚Äî";

      const topTimeHours =
        (typeof stats?.time_lost_due_to_top_delay_by_time === "number") ? stats.time_lost_due_to_top_delay_by_time
          : (typeof stats?.fallback_reason_time === "number") ? stats.fallback_reason_time : undefined;

      document.getElementById("st-delays").textContent     = (typeof totalDelays === "number") ? totalDelays : "‚Äî";
      document.getElementById("st-time-total").textContent = hoursToHM(totalTimeH);
      document.getElementById("st-major").textContent      = (typeof majorDelays === "number") ? majorDelays : "‚Äî";
      document.getElementById("st-top-reason").innerHTML   = formatReason(topReasonByTime);
      document.getElementById("st-time-top").textContent   = hoursToHM(topTimeHours);
    }

    let didAutoFocus = false;
    function focusDefaultStation(target){
      if (didAutoFocus) return;

      if (target && typeof target.lat === "number" && typeof target.lon === "number") {
        map.setView([target.lat, target.lon], 13);
        selectStation(target.name, target.lat, target.lon);
        didAutoFocus = true;
        setTimeout(()=>map.invalidateSize(), 0);
        return;
      }

      const tryKeys = ["BLOOR‚ÄìYONGE","BLOOR-YONGE","BLOOR YONGE","BLOOR‚ÄìYONGE STATION","BLOOR-YONGE STATION"];
      for (const k of tryKeys){
        const ll = stationLatLngIndex.get(k);
        if (ll){
          map.setView(ll, 13);
          selectStation(toTitle(k), ll[0], ll[1]);
          didAutoFocus = true;
          setTimeout(()=>map.invalidateSize(),0);
          return;
        }
      }

      const unionKeys = ["UNION","UNION STATION"];
      for(const k of unionKeys){
        const ll = stationLatLngIndex.get(k);
        if(ll){
          map.setView(ll, 13);
          selectStation(toTitle(k), ll[0], ll[1]);
          didAutoFocus = true;
          setTimeout(()=>map.invalidateSize(),0);
          return;
        }
      }
    }

    function toTitle(s){
      return String(s).toLowerCase().split(" ").map(w => w ? w[0].toUpperCase()+w.slice(1) : "").join(" ");
    }

    const BUCKET_LABEL = {
      morning_rush:  "Morning rush (6am‚Äì9am)",
      offpeak_day:   "Off-peak (9am‚Äì4pm)",
      evening_rush:  "Evening rush (4pm‚Äì7pm)",
      offpeak_night: "Off-peak night (7pm‚Äì2am)",
      weekend:       "Weekend"
    };
    const RUSH_TO_BUCKET = {
      "Morning":             "morning_rush",
      "Off-peak: Afternoon": "offpeak_day",
      "Evening":             "evening_rush",
      "Off-peak: Night":     "offpeak_night",
      "Weekend":             "weekend"
    };
    function lineKeyToCanon(k){ if(k==="YU") return "Line 1 ‚Äì Yonge‚ÄìUniversity"; if(k==="BD") return "Line 2 ‚Äì Bloor‚ÄìDanforth"; if(k==="SHP") return "Line 4 ‚Äì Sheppard"; return k; }
    function boundToDir(lineCanon, b){ if(lineCanon.includes("Yonge‚ÄìUniversity")) return (b==="N"?"Northbound":"Southbound"); return (b==="E"?"Eastbound":"Westbound"); }

    const lineSel = document.getElementById('line-select');
    const dirSel  = document.getElementById('dir-select');
    const rowsEl  = document.getElementById('buffer-rows');
    const dotEl   = document.getElementById('line-dot');
    const LINE_BUFFERS = {};

    function loadLineBuffers(){
      fetch(LINE_STATS_URL).then(r => {
        if(!r.ok) throw new Error("Failed to load line stats");
        return r.json();
      }).then(js => {
        const lines = js["line stats"] || [];
        lines.forEach(entryObj => {
          const rawLineKey = Object.keys(entryObj)[0];
          const canonLine = lineKeyToCanon(rawLineKey);
          LINE_BUFFERS[canonLine] = LINE_BUFFERS[canonLine] || {};

          const boundsObj = entryObj[rawLineKey] || {};
          Object.keys(boundsObj).forEach(boundLetter => {
            const dirLabel = boundToDir(canonLine, boundLetter);
            const bucketMap = (LINE_BUFFERS[canonLine][dirLabel] = LINE_BUFFERS[canonLine][dirLabel] || {});
            (boundsObj[boundLetter] || []).forEach(rec => {
              const bucket = RUSH_TO_BUCKET[rec["Rush Hour"]];
              if(!bucket) return;
              bucketMap[bucket] = rec["recommended_buffer_min"] ?? "‚Äî";
            });
          });
        });

        lineSel.innerHTML = "";
        Object.keys(LINE_BUFFERS).forEach(line => {
          const opt = document.createElement('option');
          opt.value = line; opt.textContent = line;
          lineSel.appendChild(opt);
        });
        setChosenLine(lineSel.value || "Line 1 ‚Äì Yonge‚ÄìUniversity");
      }).catch(err => { console.error(err); });
    }

    function setChosenLine(lineCanon){
      if(!LINE_BUFFERS[lineCanon]) return;
      lineSel.value = lineCanon;
      dotEl.style.background = COLOR_MAP[lineCanon] || "#6aa3ff";

      dirSel.innerHTML = "";
      const dirs = Object.keys(LINE_BUFFERS[lineCanon] || {});
      dirs.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        dirSel.appendChild(opt);
      });
      if(dirs.length) dirSel.value = dirs[0];
      renderRows();
    }

    function renderRows(){
      const line = lineSel.value;
      const dir  = dirSel.value;
      const buckets = (LINE_BUFFERS[line] || {})[dir] || {};

      rowsEl.innerHTML = "";
      Object.keys(BUCKET_LABEL).forEach(key => {
        const val = (buckets[key] ?? "‚Äî");
        const row = document.createElement('div');
        row.className = "buffer-row";
        row.innerHTML = `<div>${BUCKET_LABEL[key]}</div><div>+${val} min</div>`;
        rowsEl.appendChild(row);
      });
    }

    lineSel.addEventListener('change', () => setChosenLine(lineSel.value));
    dirSel.addEventListener('change', renderRows);
    loadLineBuffers();

    const HOT_ICONS = {
      "Track Intrusion":   L.divIcon({ className: "hotspot-icon hotspot-track",    html: '<span class="hotspot-emoji">ü¶ù</span>', iconSize: [44,44], iconAnchor: [22,22] }),
      "Disorderly Patron": L.divIcon({ className: "hotspot-icon hotspot-disorder", html: '<span class="hotspot-emoji">üôÉ</span>', iconSize: [44,44], iconAnchor: [22,22] }),
      "Fire: Track Level": L.divIcon({ className: "hotspot-icon hotspot-fire",     html: '<span class="hotspot-emoji">üî•</span>', iconSize: [44,44], iconAnchor: [22,22] })
    };
    const hotspotLayers = {
      "Track Intrusion": L.layerGroup(),
      "Disorderly Patron": L.layerGroup(),
      "Fire: Track Level": L.layerGroup()
    };

    const hotspotDefaultMarkers = {};
    function isBloorYongeKey(k){
      const u = String(k).toUpperCase();
      return u.includes("BLOOR") && u.includes("YONGE");
    }

    function buildHotspotPopup(codeName, stName, rec){
      const avgDelH  = rec["Avg Delay per Incident (hours)"];
      const avgCount = rec["Avg Count per Year"];
      const avgLostH = rec["Avg Time Lost per Year (hours)"];
      const year     = rec["Year"];
      return `
        <div style="min-width:240px">
          <div style="font-weight:700;margin-bottom:4px">${stName}</div>
          <div style="font-size:18px;font-weight:800;margin-bottom:6px">${codeName}</div>
          <div class="kpi" style="margin:6px 0"><span>Avg. Delay/Incident</span><strong>${hoursToHMVerbose(avgDelH)}</strong></div>
          <div class="kpi" style="margin:6px 0"><span>Avg. Count / Year</span><strong>${typeof avgCount === "number" ? avgCount.toFixed(1) : "‚Äî"}</strong></div>
          <div class="kpi" style="margin:6px 0"><span>Avg. Time Lost / Year</span><strong>${hoursToHMVerbose(avgLostH)}</strong></div>
          <div class="muted" style="font-size:12px;margin-top:6px">${year ?? ""}</div>
        </div>
      `;
    }

    function loadHotspots(){
      fetch(CODE_STATS_URL).then(r => {
        if(!r.ok) throw new Error("Failed to load code-specific stats");
        return r.json();
      }).then(js => {
        const blocks = js["Code Specific Station Stats"] || [];
        blocks.forEach(obj => {
          const codeName = Object.keys(obj)[0];
          const stations = obj[codeName] || {};
          Object.entries(stations).forEach(([stName, rec]) => {
            const key = String(stName).toUpperCase().trim();
            const ll = stationLatLngIndex.get(key);
            if(!ll) return;
            const marker = L.marker(ll, { icon: HOT_ICONS[codeName] || HOT_ICONS["Disorderly Patron"] })
              .bindPopup(buildHotspotPopup(codeName, stName, rec), { closeButton: true });
            (hotspotLayers[codeName] ?? hotspotLayers["Disorderly Patron"]).addLayer(marker);

            if (isBloorYongeKey(key)) { hotspotDefaultMarkers[codeName] = marker; }
          });
        });

        const container = document.getElementById('hotspot-toggles');
        container.addEventListener('click', (e) => {
          const btn = e.target.closest('button.hot-btn');
          if(!btn) return;

          Object.values(hotspotLayers).forEach(lg => { if(map.hasLayer(lg)) map.removeLayer(lg); });

          container.querySelectorAll('button.hot-btn').forEach(b => {
            b.classList.remove('is-active');
            b.setAttribute('aria-pressed', 'false');
          });
          btn.classList.add('is-active');
          btn.setAttribute('aria-pressed', 'true');

          const key = btn.dataset.hot;
          if(key !== "ALL"){
            (hotspotLayers[key] || null)?.addTo(map);
          }
          if (key !== "ALL") {
            const m = hotspotDefaultMarkers[key];
            if (m) {
              const ll = m.getLatLng();
              map.setView(ll, Math.max(map.getZoom(), 13), { animate: true });
              m.openPopup();
            }
          }
        });
      }).catch(e => { console.error(e); });
    }


    window.addEventListener('resize', () => { if (map) map.invalidateSize(); });

    function goToSearchedStation(){
      const input = document.getElementById('station-search');
      const query = String(input.value || "").trim();
      if(!query) return;

      const exactKey = query.toUpperCase();
      let targetKey = null;

      if (stationLatLngIndex.has(exactKey)) {
        targetKey = exactKey;
      } else {
        for (const k of stationLatLngIndex.keys()){
          if (k.includes(exactKey)) { targetKey = k; break; }
        }
      }

      if (!targetKey) return;

      const ll = stationLatLngIndex.get(targetKey);
      const name = toTitle(targetKey);

      map.setView(ll, Math.max(map.getZoom(), 13), { animate: true });
      selectStation(name, ll[0], ll[1]);
    }

    document.getElementById('station-go').addEventListener('click', goToSearchedStation);
    document.getElementById('station-search').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') goToSearchedStation();
    });


    /* Mobile menu JS */
    (function(){
      const btn = document.getElementById('menu-toggle');
      const nav = document.getElementById('site-nav');
      if(!btn || !nav) return;
      const closeMenu = () => {
        btn.classList.remove('is-open');
        nav.classList.remove('is-open');
        btn.setAttribute('aria-expanded','false');
      };
      btn.addEventListener('click', () => {
        const open = nav.classList.toggle('is-open');
        btn.classList.toggle('is-open', open);
        btn.setAttribute('aria-expanded', String(open));
      });
      nav.addEventListener('click', e => { if(e.target.closest('a')) closeMenu(); });
      window.addEventListener('resize', () => { if (window.innerWidth > 860) closeMenu(); });
    })();
  </script>
</body>
</html>










